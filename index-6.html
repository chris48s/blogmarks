<!DOCTYPE html>
<html prefix="        og: http://ogp.me/ns# article: http://ogp.me/ns/article#     " vocab="http://ogp.me/ns" lang="en">
<head>
<meta charset="utf-8">
<meta name="description" content="Handy links or snippets, and a sentence or two">
<meta name="viewport" content="width=device-width">
<title>Blogmarks (old posts, page 6) | Blogmarks</title>
<link href="assets/css/baguetteBox.min.css" rel="stylesheet" type="text/css">
<link href="assets/css/rst_base.css" rel="stylesheet" type="text/css">
<link href="assets/css/nikola_rst.css" rel="stylesheet" type="text/css">
<link href="assets/css/code.css" rel="stylesheet" type="text/css">
<link href="assets/css/theme.css" rel="stylesheet" type="text/css">
<link href="assets/css/custom.css" rel="stylesheet" type="text/css">
<link href="https://use.fontawesome.com/releases/v5.4.1/css/all.css" rel="stylesheet">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="alternate" type="application/rss+xml" title="RSS" hreflang="en" href="rss.xml">
<link rel="canonical" href="https://chris48s.github.io/blogmarks/index-6.html">
<link rel="prev" href="." type="text/html">
<link rel="next" href="index-5.html" type="text/html">
<!--[if lt IE 9]><script src="assets/js/html5shiv-printshiv.min.js"></script><![endif]-->
</head>
<body>
    <a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>
    <div id="container">
        
    <header id="header"><h1 id="brand"><a href="." title="Blogmarks" rel="home">

        <span id="blog-title">Blogmarks</span>
    </a></h1>

        

        
    <nav id="menu"><ul>
<li><a href="rss.xml">RSS feed</a></li>
                <li><a href="categories/">Tags</a></li>

    

    
    
    </ul></nav></header><main id="content"><div class="postindex">
    <article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/2022/mocha-markdown/" class="u-url">Generating a GitHub Markdown Summary from Mocha</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                chris48s
            </span></p>
            <p class="dateline">
            <a href="posts/2022/mocha-markdown/" rel="bookmark">
            <time class="published dt-published" datetime="2022-09-20T00:00:00+01:00" itemprop="datePublished" title="2022-09-20">2022-09-20</time></a>
            </p>
        </div>
    </header><div class="e-content entry-content">
    <p>I recently wanted to migrate some CI builds running mocha tests from CircleCI to GitHub Actions. I also wanted to use <a href="https://github.blog/2022-05-09-supercharging-github-actions-with-job-summaries/">Job Summaries</a> to produce a markdown summary of the build. This allows you to output a summary of your workflow run by echoing markdown to a special environment variable called <code>$GITHUB_STEP_SUMMARY</code> e.g: <code>echo '### Hello world! :rocket:' &gt;&gt; $GITHUB_STEP_SUMMARY</code></p>
<p>We run our tests with mocha, which doesn't ship with a markdown output formatter. The "min" formatter was quite close to what I wanted (a markdown summary of any failed tests but a "quiet" output if everything passed). Dumping that to a code fence would have probably been acceptable. Unfortunately our test suite has a number of tests which log output to stdout which made things a bit messy as the "min" formatter also dumps to stdout. So I decided to write a quick script to parse mocha's json output and produce a markdown summary. Doing this also allowed me to uses some nicer formatting than dumping console output into a code fence.</p>
<div class="code"><pre class="code literal-block"><span class="c1">// mocha2md.js</span>

<span class="k">import</span><span class="w"> </span><span class="nx">fs</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'fs'</span>

<span class="kd">const</span><span class="w"> </span><span class="nx">title</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">process</span><span class="p">.</span><span class="nx">argv</span><span class="p">[</span><span class="mf">2</span><span class="p">]</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">fs</span><span class="p">.</span><span class="nx">readFileSync</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">argv</span><span class="p">[</span><span class="mf">3</span><span class="p">]))</span>

<span class="nx">process</span><span class="p">.</span><span class="nx">stdout</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="sb">`# </span><span class="si">${</span><span class="nx">title</span><span class="si">}</span><span class="sb">\n\n`</span><span class="p">)</span>

<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">stats</span><span class="p">.</span><span class="nx">passes</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">process</span><span class="p">.</span><span class="nx">stdout</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="sb">`✔ </span><span class="si">${</span><span class="nx">data</span><span class="p">.</span><span class="nx">stats</span><span class="p">.</span><span class="nx">passes</span><span class="si">}</span><span class="sb"> passed\n`</span><span class="p">)</span>
<span class="p">}</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">stats</span><span class="p">.</span><span class="nx">failures</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">process</span><span class="p">.</span><span class="nx">stdout</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="sb">`✖ </span><span class="si">${</span><span class="nx">data</span><span class="p">.</span><span class="nx">stats</span><span class="p">.</span><span class="nx">failures</span><span class="si">}</span><span class="sb"> failed\n\n`</span><span class="p">)</span>
<span class="p">}</span>

<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">stats</span><span class="p">.</span><span class="nx">failures</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="nx">test</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nx">data</span><span class="p">.</span><span class="nx">tests</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">test</span><span class="p">.</span><span class="nx">err</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">test</span><span class="p">.</span><span class="nx">err</span><span class="p">).</span><span class="nx">length</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">process</span><span class="p">.</span><span class="nx">stdout</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="sb">`### </span><span class="si">${</span><span class="nx">test</span><span class="p">.</span><span class="nx">title</span><span class="si">}</span><span class="sb">\n\n`</span><span class="p">)</span>
<span class="w">      </span><span class="nx">process</span><span class="p">.</span><span class="nx">stdout</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="sb">`</span><span class="si">${</span><span class="nx">test</span><span class="p">.</span><span class="nx">fullTitle</span><span class="si">}</span><span class="sb">\n\n`</span><span class="p">)</span>
<span class="w">      </span><span class="nx">process</span><span class="p">.</span><span class="nx">stdout</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="s1">'```\n'</span><span class="p">)</span>
<span class="w">      </span><span class="nx">process</span><span class="p">.</span><span class="nx">stdout</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="sb">`</span><span class="si">${</span><span class="nx">test</span><span class="p">.</span><span class="nx">err</span><span class="p">.</span><span class="nx">stack</span><span class="si">}</span><span class="sb">\n`</span><span class="p">)</span>
<span class="w">      </span><span class="nx">process</span><span class="p">.</span><span class="nx">stdout</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="s1">'```\n\n'</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>

<p>Combine that with some workflow yaml to run the tests with the json reporter and use our script to write the report.</p>
<div class="code"><pre class="code literal-block"><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Run tests</span>
<span class="w">  </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">npm run test:core -- --reporter json --reporter-option 'output=reports/test.json'</span>

<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Write Markdown Summary</span>
<span class="w">  </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">node mocha2md.js Tests reports/test.json &gt;&gt; $GITHUB_STEP_SUMMARY</span>
</pre></div>

<p>and we've got ourselves a nice little summary report from our mocha tests.</p>
<p><img alt="example markdown summary" src="images/markdown-summary.png"></p>
    </div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/2022/diagrams/" class="u-url">Diagrams</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                chris48s
            </span></p>
            <p class="dateline">
            <a href="posts/2022/diagrams/" rel="bookmark">
            <time class="published dt-published" datetime="2022-09-18T00:00:00+01:00" itemprop="datePublished" title="2022-09-18">2022-09-18</time></a>
            </p>
        </div>
    </header><div class="e-content entry-content">
    <p>Last week I tried out <a href="https://diagrams.mingrammer.com/">diagrams</a> to knock up some cloud infrastructure diagrams. There are several things I really like about this tool:</p>
<ul>
<li>The learning curve is very easy. I was able to absorb the key concepts and produce a useful diagram showing the AWS setup for an application I am working on within about 30 mins of installing it for the first time.</li>
<li>The [effort in]:[pretty pictures out] ratio is very satisfying.</li>
<li>Because the diagram is generated from code, it can live in your repo. The diff changing the diagram could be in the same commit as the updates to your CDK definitions or ansible playbooks or whatever it is that actually makes the infrastructure changes.</li>
</ul>
<p>For example, the following diagram</p>
<p><img alt="example diagram" src="images/diagram.png"></p>
<p>is generated from this short python snippet:</p>
<div class="code"><pre class="code literal-block"><span class="kn">from</span> <span class="nn">diagrams</span> <span class="kn">import</span> <span class="n">Cluster</span><span class="p">,</span> <span class="n">Diagram</span>
<span class="kn">from</span> <span class="nn">diagrams.aws.compute</span> <span class="kn">import</span> <span class="n">Fargate</span>
<span class="kn">from</span> <span class="nn">diagrams.aws.database</span> <span class="kn">import</span> <span class="n">RDS</span><span class="p">,</span> <span class="n">ElastiCache</span>
<span class="kn">from</span> <span class="nn">diagrams.aws.engagement</span> <span class="kn">import</span> <span class="n">SES</span>
<span class="kn">from</span> <span class="nn">diagrams.aws.network</span> <span class="kn">import</span> <span class="n">ELB</span><span class="p">,</span> <span class="n">Route53</span>
<span class="kn">from</span> <span class="nn">diagrams.aws.storage</span> <span class="kn">import</span> <span class="n">S3</span>

<span class="k">with</span> <span class="n">Diagram</span><span class="p">(</span><span class="s2">""</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">ses</span> <span class="o">=</span> <span class="n">SES</span><span class="p">(</span><span class="s2">"Mail Transport (SES)"</span><span class="p">)</span>
    <span class="n">dns</span> <span class="o">=</span> <span class="n">Route53</span><span class="p">(</span><span class="s2">"Route 53 (DNS)"</span><span class="p">)</span>
    <span class="n">s3</span> <span class="o">=</span> <span class="n">S3</span><span class="p">(</span><span class="s2">"S3"</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">Cluster</span><span class="p">(</span><span class="s2">"VPC"</span><span class="p">):</span>
        <span class="n">lb</span> <span class="o">=</span> <span class="n">ELB</span><span class="p">(</span><span class="s2">"Load Balancer (ALB)"</span><span class="p">)</span>
        <span class="n">elasticache</span> <span class="o">=</span> <span class="n">ElastiCache</span><span class="p">(</span><span class="s2">"Redis (ElastiCache)"</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">Cluster</span><span class="p">(</span><span class="s2">"ECS"</span><span class="p">):</span>
            <span class="n">web</span> <span class="o">=</span> <span class="n">Fargate</span><span class="p">(</span><span class="s2">"web"</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">Cluster</span><span class="p">(</span><span class="s2">"DB Cluster (RDS)"</span><span class="p">):</span>
            <span class="n">db_primary</span> <span class="o">=</span> <span class="n">RDS</span><span class="p">(</span><span class="s2">"primary"</span><span class="p">)</span>
            <span class="n">db_primary</span> <span class="o">-</span> <span class="n">RDS</span><span class="p">(</span><span class="s2">"read replica"</span><span class="p">)</span>

    <span class="n">dns</span> <span class="o">&gt;&gt;</span> <span class="n">lb</span>
    <span class="n">lb</span> <span class="o">&gt;&gt;</span> <span class="n">web</span>

    <span class="n">web</span> <span class="o">&gt;&gt;</span> <span class="n">elasticache</span>
    <span class="n">web</span> <span class="o">&gt;&gt;</span> <span class="n">db_primary</span>
    <span class="n">web</span> <span class="o">&gt;&gt;</span> <span class="n">s3</span>
    <span class="n">web</span> <span class="o">&gt;&gt;</span> <span class="n">ses</span>
</pre></div>
    </div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/2022/three-programming-blogs/" class="u-url">Three great programming blogs</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                chris48s
            </span></p>
            <p class="dateline">
            <a href="posts/2022/three-programming-blogs/" rel="bookmark">
            <time class="published dt-published" datetime="2022-09-16T00:00:00+01:00" itemprop="datePublished" title="2022-09-16">2022-09-16</time></a>
            </p>
        </div>
    </header><div class="e-content entry-content">
    <p>These are some of my favourite programming bloggers. All 3 of these are consistently knocking out quality posts and well worth a follow:</p>
<ol>
<li><a href="https://martinheinz.dev/">Martin Heinz</a></li>
<li><a href="https://adamj.eu/tech">Adam Johnson</a></li>
<li><a href="https://roman.pt/">Roman Imankulov</a></li>
</ol>
</div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/2022/rich-tips/" class="u-url">Three Rich tips</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                chris48s
            </span></p>
            <p class="dateline">
            <a href="posts/2022/rich-tips/" rel="bookmark">
            <time class="published dt-published" datetime="2022-02-13T00:00:00Z" itemprop="datePublished" title="2022-02-13">2022-02-13</time></a>
            </p>
        </div>
    </header><div class="e-content entry-content">
    <p>I've mentioned Will McGugan's excellent library <a href="https://github.com/willmcgugan/rich">Rich</a> on this blog before. It is a great tool for building nice terminal interfaces, but it is also an important local development tool. Here's three top tips:</p>
<ol>
<li>Rich can be registered as a <a href="https://rich.readthedocs.io/en/stable/traceback.html#traceback-handler">handler to render stacktraces</a>. As well as the aesthetics, using Rich to handle stacktraces like this provides additional context which improves the usefulness of error messages in comparison to python's default handler.</li>
<li>
<a href="https://github.com/Textualize/rich#rich-inspect">Rich.inspect</a> can be used to examine a python object at runtime. I used to use <code>dir()</code> or <code>vars()</code> for this, but <code>rich.inspect()</code> is a big step up.</li>
<li>Rich can be used as a log handler. <a href="https://rich.readthedocs.io/en/stable/logging.html">The docs</a> cover how to use it with python's <code>logging</code> module, but Will has also published this <a href="https://www.willmcgugan.com/blog/tech/post/richer-django-logging/">blog post</a> showing how to configure Django to use Rich as the default log handler.</li>
</ol>
</div>
    </article>
</div>

        <nav class="postindexpager"><ul class="pager">
<li class="previous">
                <a href="." rel="prev">Newer posts</a>
            </li>
            <li class="next">
                <a href="index-5.html" rel="next">Older posts</a>
            </li>
        </ul></nav></main><footer id="footer"><p>
</p>
<p>Contents © 2025 chris48s</p>

<ul class="no-bullet">
<li>
    <i class="fab fa-github"></i>
    <a href="https://github.com/chris48s/" target="_blank">Github</a>
  </li>
  <li>
    <i class="fab fa-mastodon"></i>
    <a href="https://fed.chris-shaw.dev/@chris" target="_blank">Mastodon</a>
  </li>
</ul></footer>
</div>
    
            <script src="assets/js/baguetteBox.min.js"></script><script>
    baguetteBox.run('main#content', {
        ignoreClass: 'islink',
        captions: function(element){var i=element.getElementsByTagName('img')[0];return i===undefined?'':i.alt;}});
    </script>
</body>
</html>
